---
phase: 01-foundation-language-modernization
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/test/java/com/mojang/tower/GoldenMasterTest.java
  - src/test/java/com/mojang/tower/GameState.java
  - src/test/java/com/mojang/tower/EntityState.java
  - src/test/java/com/mojang/tower/ResourceState.java
  - src/test/java/com/mojang/tower/GameRunner.java
  - src/test/resources/golden/full-game-snapshot.json
  - src/main/java/com/mojang/tower/Island.java
autonomous: true

must_haves:
  truths:
    - "Golden master test runs to completion and captures game state each tick"
    - "Test uses deterministic seeding (8844) for reproducible results"
    - "Snapshot JSON is human-readable and diffable"
    - "Test fails if game behavior changes (state divergence detected)"
  artifacts:
    - path: "src/test/java/com/mojang/tower/GoldenMasterTest.java"
      provides: "Main golden master test class"
      contains: "fullGameplayMatchesGoldenMaster"
    - path: "src/test/java/com/mojang/tower/GameState.java"
      provides: "Per-tick state record for snapshot"
      contains: "record GameState"
    - path: "src/test/java/com/mojang/tower/GameRunner.java"
      provides: "Headless game runner for deterministic execution"
      contains: "runDeterministicGame"
    - path: "src/test/resources/golden/full-game-snapshot.json"
      provides: "Approved golden master snapshot"
  key_links:
    - from: "GoldenMasterTest.java"
      to: "GameRunner.java"
      via: "runDeterministicGame method call"
      pattern: "runDeterministicGame"
    - from: "GameRunner.java"
      to: "Island.java"
      via: "tick() invocation for headless simulation"
      pattern: "island\\.tick\\(\\)"
    - from: "GoldenMasterTest.java"
      to: "full-game-snapshot.json"
      via: "Jackson ObjectMapper read/write"
      pattern: "ObjectMapper.*writeValue|readValue"
---

<objective>
Create golden master test infrastructure that captures tick-by-tick game state and compares against an approved baseline.

Purpose: This is the critical safety net for all subsequent refactoring. Any behavioral change will cause the golden master test to fail, immediately identifying regressions.

Output: JUnit 5 test that runs deterministic game simulation, captures state to JSON, and verifies against approved snapshot.
</objective>

<execution_context>
@/home/docinhos/.claude/get-shit-done/workflows/execute-plan.md
@/home/docinhos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-language-modernization/01-CONTEXT.md
@.planning/phases/01-foundation-language-modernization/01-RESEARCH.md
@.planning/phases/01-foundation-language-modernization/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create state capture records and headless game runner</name>
  <files>
    src/test/java/com/mojang/tower/GameState.java
    src/test/java/com/mojang/tower/EntityState.java
    src/test/java/com/mojang/tower/ResourceState.java
    src/test/java/com/mojang/tower/GameRunner.java
  </files>
  <action>
Create state capture records (use Java records for immutability):

**GameState.java:**
```java
public record GameState(
    int tick,
    List<EntityState> entities,
    ResourceState resources,
    int population,
    int populationCap,
    int monsterPopulation,
    int warriorPopulation,
    int warriorPopulationCap,
    boolean titleScreen,
    boolean won
) {}
```

**EntityState.java:**
```java
public record EntityState(
    String type,          // Entity class simple name
    double x,
    double y,
    double r,
    boolean alive,
    Integer hp,           // nullable for entities without HP
    String jobType,       // nullable, Job inner class name or null
    Integer carrying      // nullable, resource being carried
) {}
```
Sort entities by (type, x, y) for stable ordering in snapshots.

**ResourceState.java:**
```java
public record ResourceState(int wood, int rock, int food) {}
```

**GameRunner.java:**
Create headless game runner that:
1. Creates Island with fixed seed (8844 - already hardcoded in Island.java)
2. Runs game loop without rendering (call island.tick() directly)
3. Captures GameState after each tick
4. Runs until win condition OR max ticks (e.g., 50000 as safety limit)
5. Returns List<GameState>

Key implementation details:
- Create mock/minimal TowerComponent that doesn't need AWT (Island constructor needs it)
- Use reflection or add package-private accessor if needed to read game state
- Capture entity state by iterating island.entities
- For Peon: capture hp, job type (job.getClass().getSimpleName()), carrying
- For Monster: capture hp
- For House: capture buildProgress if applicable
- Skip entities where state isn't relevant (Puff, InfoPuff)

Handle Random determinism:
- Island already uses seed 8844
- Entity, Monster, Peon may have their own Random - check and seed if needed
- If other classes have Random, either inject seed or note as test limitation
  </action>
  <verify>
Run: `mvn compile -f pom.xml` - test classes compile
Run: `mvn test -Dtest=GameRunnerTest` (create simple sanity test) - runner executes
  </verify>
  <done>State capture records defined. GameRunner can execute headless game simulation and capture tick-by-tick state.</done>
</task>

<task type="auto">
  <name>Task 2: Create golden master test and generate initial snapshot</name>
  <files>
    src/test/java/com/mojang/tower/GoldenMasterTest.java
    src/test/resources/golden/full-game-snapshot.json
  </files>
  <action>
Create GoldenMasterTest.java with JUnit 5:

```java
@Test
void fullGameplayMatchesGoldenMaster() throws Exception {
    Path goldenPath = Path.of("src/test/resources/golden/full-game-snapshot.json");
    ObjectMapper mapper = new ObjectMapper()
        .enable(SerializationFeature.INDENT_OUTPUT);

    // Run deterministic game
    List<GameState> actualStates = GameRunner.runDeterministicGame();

    if (Files.exists(goldenPath)) {
        // Compare mode - verify against approved snapshot
        List<GameState> expectedStates = mapper.readValue(
            goldenPath.toFile(),
            new TypeReference<List<GameState>>() {}
        );

        assertEquals(expectedStates.size(), actualStates.size(),
            "Game length changed - expected " + expectedStates.size() + " ticks");

        for (int i = 0; i < expectedStates.size(); i++) {
            GameState expected = expectedStates.get(i);
            GameState actual = actualStates.get(i);
            assertEquals(expected, actual,
                "State diverged at tick " + i + ". Run with -DupdateGoldenMaster=true to see diff");
        }
    } else {
        // Initial capture mode - generate snapshot
        mapper.writeValue(goldenPath.toFile(), actualStates);
        fail("Golden master snapshot created at " + goldenPath +
             ". Review the snapshot and re-run the test.");
    }
}
```

Run the test to generate initial snapshot:
1. `mvn test -Dtest=GoldenMasterTest`
2. Test will fail with "Golden master snapshot created" message
3. Review the generated JSON (should show tick progression, entity states)
4. Re-run test - should pass

If game takes too long (>50000 ticks), investigate:
- May need to reduce max ticks for CI
- Or sample every Nth tick instead of every tick
- Document decision in test comments

The snapshot file will be large (potentially MB) - this is expected for full game capture.
Commit the snapshot to git as the approved baseline.
  </action>
  <verify>
Run: `mvn test -Dtest=GoldenMasterTest` - test passes (after initial generation)
Run: `ls -la src/test/resources/golden/full-game-snapshot.json` - snapshot exists
Run: `head -50 src/test/resources/golden/full-game-snapshot.json` - valid JSON structure
  </verify>
  <done>Golden master test passes. Snapshot captures complete game state. Any future behavioral change will fail this test.</done>
</task>

</tasks>

<verification>
1. `mvn test` runs golden master test successfully
2. Snapshot JSON exists and contains tick-by-tick state
3. Modifying game logic (temporarily) causes test to fail (behavior verified)
4. Restoring game logic makes test pass again
</verification>

<success_criteria>
- GameState, EntityState, ResourceState records exist in test source
- GameRunner executes headless game simulation
- GoldenMasterTest.java exists with fullGameplayMatchesGoldenMaster test
- full-game-snapshot.json contains approved baseline
- `mvn test` passes with golden master verification
- Test correctly fails if game behavior is modified
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-language-modernization/01-02-SUMMARY.md`
</output>
