---
phase: 01-foundation-language-modernization
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - src/main/java/com/mojang/tower/Vec.java
  - src/main/java/com/mojang/tower/Entity.java
  - src/main/java/com/mojang/tower/Peon.java
  - src/main/java/com/mojang/tower/Monster.java
  - src/main/java/com/mojang/tower/House.java
  - src/main/java/com/mojang/tower/Job.java
  - src/main/java/com/mojang/tower/TowerComponent.java
  - src/main/java/com/mojang/tower/Island.java
  - src/main/java/com/mojang/tower/Resources.java
  - src/main/java/com/mojang/tower/Tower.java
  - src/main/java/com/mojang/tower/Tree.java
  - src/main/java/com/mojang/tower/Rock.java
  - src/main/java/com/mojang/tower/FarmPlot.java
  - src/main/java/com/mojang/tower/Bitmaps.java
  - src/main/java/com/mojang/tower/HouseType.java
  - src/main/java/com/mojang/tower/Sounds.java
  - src/main/java/com/mojang/tower/Sound.java
  - src/main/java/com/mojang/tower/Puff.java
  - src/main/java/com/mojang/tower/InfoPuff.java
  - src/main/java/com/mojang/tower/TargetFilter.java
  - src/main/java/com/mojang/tower/TowerApplet.java
autonomous: true

must_haves:
  truths:
    - "Vec is a record with x(), y(), z() accessor methods"
    - "All instanceof+cast chains use pattern matching"
    - "Resources.add() uses switch expression with arrow syntax"
    - "var used for local variables where type is obvious (new, literals, factory methods)"
    - "Golden master test still passes (behavior preserved)"
  artifacts:
    - path: "src/main/java/com/mojang/tower/Vec.java"
      provides: "Immutable Vec record with math operations"
      contains: "public record Vec"
    - path: "src/main/java/com/mojang/tower/Resources.java"
      provides: "Resource management with switch expression"
      contains: "switch.*->|case.*->"
    - path: "src/main/java/com/mojang/tower/Peon.java"
      provides: "Peon with pattern matching instanceof"
      contains: "instanceof Monster monster|instanceof Peon peon"
    - path: "src/main/java/com/mojang/tower/House.java"
      provides: "House with pattern matching instanceof"
      contains: "instanceof Peon peon"
  key_links:
    - from: "*.java (all files using Vec)"
      to: "Vec.java"
      via: "accessor method calls x(), y(), z()"
      pattern: "\\.x\\(\\)|\\.y\\(\\)|\\.z\\(\\)"
    - from: "Peon.java"
      to: "Job.java"
      via: "pattern matched Monster for Hunt job"
      pattern: "instanceof Monster monster.*Hunt\\(monster\\)"
---

<objective>
Convert Vec to a Java record and modernize syntax across the codebase using pattern matching, switch expressions, and var declarations.

Purpose: Adopt Java 21 language features that improve readability and type safety. Vec as a record gains automatic equals/hashCode (value semantics). Pattern matching eliminates unsafe casts. Switch expressions prevent fall-through bugs.

Output: Fully modernized Java 21 syntax with golden master tests confirming behavior preservation.
</objective>

<execution_context>
@/home/docinhos/.claude/get-shit-done/workflows/execute-plan.md
@/home/docinhos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-language-modernization/01-CONTEXT.md
@.planning/phases/01-foundation-language-modernization/01-RESEARCH.md
@.planning/phases/01-foundation-language-modernization/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert Vec class to record and update all usages</name>
  <files>
    src/main/java/com/mojang/tower/Vec.java
    src/main/java/com/mojang/tower/Entity.java
    src/main/java/com/mojang/tower/Peon.java
    src/main/java/com/mojang/tower/Monster.java
    src/main/java/com/mojang/tower/Tower.java
    src/main/java/com/mojang/tower/Puff.java
    src/main/java/com/mojang/tower/InfoPuff.java
  </files>
  <action>
**Convert Vec.java to record:**

```java
package com.mojang.tower;

public record Vec(double x, double y, double z) {

    // Copy constructor for compatibility (if new Vec(existingVec) is used)
    public Vec(Vec v) {
        this(v.x(), v.y(), v.z());
    }

    public double distance(Vec v) {
        return Math.sqrt(distanceSqr(v));
    }

    public double distanceSqr(Vec v) {
        double xd = v.x() - x;  // Use accessor methods
        double yd = v.y() - y;
        double zd = v.z() - z;
        return xd * xd + yd * yd + zd * zd;
    }

    public Vec rotate(double sin, double cos) {
        double _x = x * cos + z * sin;
        double _y = y;
        double _z = x * sin - z * cos;
        return new Vec(_x, _y, _z);
    }

    public Vec project() {
        double _x = x / z * 320;
        double _y = y / z * 320;
        double _z = z;
        return new Vec(_x, _y, _z);
    }

    public double lengthSqr() {
        return x * x + y * y + z * z;
    }

    public Vec add(Vec m) {
        return new Vec(x + m.x(), y + m.y(), z + m.z());
    }

    public Vec scale(double v) {
        return new Vec(x * v, y * v, z * v);
    }

    public Vec sub(Vec m) {
        return new Vec(x - m.x(), y - m.y(), z - m.z());
    }
}
```

**Update all usages of Vec fields:**

Records use accessor methods, not public fields. Find and replace:
- `vec.x` -> `vec.x()`
- `vec.y` -> `vec.y()`
- `vec.z` -> `vec.z()`

Files to check (grep for `\.x[^(]|\.y[^(]|\.z[^(]` on Vec usages):
- Entity.java (uses Vec for position calculations in updatePos, render)
- Peon.java (movement calculations)
- Monster.java (movement calculations)
- Tower.java (rendering)
- Puff.java (animation)
- InfoPuff.java (animation)

Also check for `new Vec(existingVec)` copy constructor usages - keep working with the explicit copy constructor added to the record.

**Compile and test after each file:**
```bash
mvn compile
mvn test -Dtest=GoldenMasterTest
```
  </action>
  <verify>
Run: `mvn compile` - no compilation errors
Run: `grep -r "public record Vec" src/main/java` - Vec is a record
Run: `mvn test -Dtest=GoldenMasterTest` - golden master still passes
  </verify>
  <done>Vec is a record with value semantics. All usages updated to accessor methods. Golden master passes.</done>
</task>

<task type="auto">
  <name>Task 2: Apply pattern matching, switch expressions, and var</name>
  <files>
    src/main/java/com/mojang/tower/Peon.java
    src/main/java/com/mojang/tower/Monster.java
    src/main/java/com/mojang/tower/House.java
    src/main/java/com/mojang/tower/Job.java
    src/main/java/com/mojang/tower/TowerComponent.java
    src/main/java/com/mojang/tower/Resources.java
    src/main/java/com/mojang/tower/Island.java
    src/main/java/com/mojang/tower/Bitmaps.java
    src/main/java/com/mojang/tower/HouseType.java
    src/main/java/com/mojang/tower/Tree.java
    src/main/java/com/mojang/tower/Rock.java
    src/main/java/com/mojang/tower/FarmPlot.java
    src/main/java/com/mojang/tower/Sound.java
    src/main/java/com/mojang/tower/Sounds.java
  </files>
  <action>
**Pattern Matching for instanceof (12 locations from research):**

Convert all `instanceof X` followed by cast to pattern matching:

Peon.java (4 instances):
```java
// BEFORE: if (e instanceof Monster) { setJob(new Job.Hunt((Monster) e)); }
// AFTER:
if (e instanceof Monster monster) {
    setJob(new Job.Hunt(monster));
}

// BEFORE: if (!(target instanceof Tree)) { target = null; }
// AFTER:
if (!(target instanceof Tree)) {
    target = null;
}
// (no cast needed here, just type check)

// BEFORE: job instanceof Job.Goto
// AFTER: (same - no cast, just type check)
```

Monster.java (2 instances):
```java
// BEFORE: if (e instanceof House || e instanceof Peon)
// AFTER: (same - no cast needed, just type check)
```

House.java (3 instances):
```java
// BEFORE: if (e instanceof Peon) { Peon peon = (Peon) e; return peon; }
// AFTER:
if (e instanceof Peon peon) {
    return peon;
}

// For filter accepts methods, pattern matching where cast follows
```

TowerComponent.java (2 instances):
```java
// BEFORE: return e instanceof House;
// AFTER: (same - no cast, used in filter)

// BEFORE: ((House) e).sell();
// Find the instanceof check and use pattern matching
if (e instanceof House house) {
    house.sell();
}
```

Job.java (1 instance):
```java
// BEFORE: return e instanceof Monster;
// AFTER: (same - no cast needed)
```

**Switch Expression in Resources.java:**

```java
// BEFORE:
public void add(int resourceId, int count) {
    switch(resourceId) {
        case WOOD: wood+=count; break;
        case ROCK: rock+=count; break;
        case FOOD: food+=count; break;
    }
}

// AFTER:
public void add(int resourceId, int count) {
    switch (resourceId) {
        case WOOD -> wood += count;
        case ROCK -> rock += count;
        case FOOD -> food += count;
        default -> {} // silently ignore invalid resourceId (matches original behavior)
    }
}
```

**var usage (conservative - only where type obvious):**

Apply var where type is obvious from RHS (new, literals, factory methods):
```java
// GOOD examples:
var mapper = new ObjectMapper();
var monster = new Monster(x, y);
var path = Path.of("...");
var entities = new ArrayList<Entity>();
var count = 0;

// AVOID - type not obvious:
// var e = island.getEntityAt(x, y, r, filter);  // Keep explicit type
// var result = someMethod();  // Keep explicit type
```

Sweep through files systematically:
- Island.java: `new Random`, `new ArrayList<Entity>`, `new House`, `new Peon`, etc.
- TowerComponent.java: `new BufferStrategy`, etc.
- Bitmaps.java: `new BufferedImage`, etc.
- Other entity classes: constructors, collections

**Compile and test after each file change:**
Run `mvn compile && mvn test -Dtest=GoldenMasterTest` after each file.
If golden master fails, investigate immediately - don't proceed until fixed.
  </action>
  <verify>
Run: `mvn compile` - no compilation errors
Run: `grep -rn "instanceof.*{" src/main/java | grep -v "//"` - pattern matching used where applicable
Run: `grep -n "case.*->" src/main/java/com/mojang/tower/Resources.java` - switch expression syntax
Run: `mvn test -Dtest=GoldenMasterTest` - golden master passes (behavior preserved)
  </verify>
  <done>Pattern matching, switch expressions, and var applied throughout codebase. Golden master confirms behavior unchanged.</done>
</task>

</tasks>

<verification>
1. Vec.java declares `public record Vec`
2. No `vec.x` field access remains (all converted to `vec.x()`)
3. Resources.add() uses switch expression with `->` syntax
4. All 12 instanceof locations reviewed for pattern matching
5. `var` used conservatively where type obvious
6. `mvn test` passes - golden master verification succeeds
7. `mvn compile` has no warnings about deprecated patterns
</verification>

<success_criteria>
- Vec is a Java record with automatic equals/hashCode
- All Vec field accesses use accessor methods x(), y(), z()
- Pattern matching used for all instanceof+cast patterns
- Resources.add() uses switch expression
- var used for obvious type declarations
- `mvn test -Dtest=GoldenMasterTest` passes (behavior preserved)
- Code compiles cleanly with Java 21
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-language-modernization/01-03-SUMMARY.md`
</output>
