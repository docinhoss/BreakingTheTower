---
phase: 01-foundation-language-modernization
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - src/com/mojang/tower/Vec.java
  - src/com/mojang/tower/Cost.java
  - src/com/mojang/tower/HouseType.java
  - src/com/mojang/tower/Resources.java
  - src/com/mojang/tower/Entity.java
  - src/com/mojang/tower/Peon.java
  - src/com/mojang/tower/Monster.java
  - src/com/mojang/tower/House.java
  - src/com/mojang/tower/Job.java
  - src/com/mojang/tower/TowerComponent.java
  - src/com/mojang/tower/Island.java
  - src/com/mojang/tower/Tower.java
  - src/com/mojang/tower/Tree.java
  - src/com/mojang/tower/Rock.java
  - src/com/mojang/tower/FarmPlot.java
  - src/com/mojang/tower/Bitmaps.java
  - src/com/mojang/tower/Sounds.java
  - src/com/mojang/tower/Sound.java
  - src/com/mojang/tower/Puff.java
  - src/com/mojang/tower/InfoPuff.java
  - src/com/mojang/tower/TargetFilter.java
  - src/com/mojang/tower/TowerApplet.java
autonomous: true

must_haves:
  truths:
    - "Vec is a record with x(), y(), z() accessor methods"
    - "Cost is a record representing building costs (wood, rock, food)"
    - "HouseType uses Cost record for building costs"
    - "All instanceof+cast chains use pattern matching"
    - "Resources.add() uses switch expression with arrow syntax"
    - "var used for local variables where type is obvious (new, literals, factory methods)"
    - "Golden master test still passes (behavior preserved)"
  artifacts:
    - path: "src/com/mojang/tower/Vec.java"
      provides: "Immutable Vec record with math operations"
      contains: "public record Vec"
    - path: "src/com/mojang/tower/Cost.java"
      provides: "Immutable Cost record for building costs"
      contains: "public record Cost"
    - path: "src/com/mojang/tower/HouseType.java"
      provides: "HouseType using Cost record"
      contains: "Cost cost|public Cost cost()"
    - path: "src/com/mojang/tower/Resources.java"
      provides: "Resource management with switch expression"
      contains: "switch.*->|case.*->"
    - path: "src/com/mojang/tower/Peon.java"
      provides: "Peon with pattern matching instanceof"
      contains: "instanceof Monster monster|instanceof Peon peon"
    - path: "src/com/mojang/tower/House.java"
      provides: "House with pattern matching instanceof"
      contains: "instanceof Peon peon"
  key_links:
    - from: "Vec.java (internal methods)"
      to: "Vec record components"
      via: "accessor method calls x(), y(), z() within Vec methods"
      pattern: "\\.x\\(\\)|\\.y\\(\\)|\\.z\\(\\)"
    - from: "HouseType.java"
      to: "Cost.java"
      via: "Cost record for building costs"
      pattern: "new Cost\\(|Cost cost"
    - from: "Resources.java"
      to: "Cost.java"
      via: "charge() and canAfford() methods use Cost"
      pattern: "cost\\.wood\\(\\)|cost\\.rock\\(\\)|cost\\.food\\(\\)"
    - from: "Peon.java"
      to: "Job.java"
      via: "pattern matched Monster for Hunt job"
      pattern: "instanceof Monster monster.*Hunt\\(monster\\)"
---

<objective>
Convert Vec and Cost to Java records and modernize syntax across the codebase using pattern matching, switch expressions, and var declarations.

Purpose: Adopt Java 21 language features that improve readability and type safety. Vec and Cost as records gain automatic equals/hashCode (value semantics). Pattern matching eliminates unsafe casts. Switch expressions prevent fall-through bugs.

Output: Fully modernized Java 21 syntax with golden master tests confirming behavior preservation.
</objective>

<execution_context>
@/home/docinhos/.claude/get-shit-done/workflows/execute-plan.md
@/home/docinhos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-language-modernization/01-CONTEXT.md
@.planning/phases/01-foundation-language-modernization/01-RESEARCH.md
@.planning/phases/01-foundation-language-modernization/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert Vec class to record</name>
  <files>
    src/com/mojang/tower/Vec.java
  </files>
  <action>
**Convert Vec.java to record:**

```java
package com.mojang.tower;

public record Vec(double x, double y, double z) {

    // Copy constructor for compatibility (if new Vec(existingVec) is used)
    public Vec(Vec v) {
        this(v.x(), v.y(), v.z());
    }

    public double distance(Vec v) {
        return Math.sqrt(distanceSqr(v));
    }

    public double distanceSqr(Vec v) {
        double xd = v.x() - x;  // Use accessor methods
        double yd = v.y() - y;
        double zd = v.z() - z;
        return xd * xd + yd * yd + zd * zd;
    }

    public Vec rotate(double sin, double cos) {
        double _x = x * cos + z * sin;
        double _y = y;
        double _z = x * sin - z * cos;
        return new Vec(_x, _y, _z);
    }

    public Vec project() {
        double _x = x / z * 320;
        double _y = y / z * 320;
        double _z = z;
        return new Vec(_x, _y, _z);
    }

    public double lengthSqr() {
        return x * x + y * y + z * z;
    }

    public Vec add(Vec m) {
        return new Vec(x + m.x(), y + m.y(), z + m.z());
    }

    public Vec scale(double v) {
        return new Vec(x * v, y * v, z * v);
    }

    public Vec sub(Vec m) {
        return new Vec(x - m.x(), y - m.y(), z - m.z());
    }
}
```

**Important:** Vec is ONLY used internally within Vec.java itself. No other files in the codebase use the Vec class. The `.x`, `.y`, `.z` field accesses in other files (Entity, Monster, Peon, etc.) refer to Entity position fields, NOT Vec fields. Therefore, only Vec.java needs updating.

**Verify Vec is only used in Vec.java:**
```bash
grep -r "Vec" src/com/mojang/tower/ --include="*.java" | grep -v "Vec.java"
```
Should return nothing.

**Compile and test:**
```bash
mvn compile
mvn test -Dtest=GoldenMasterTest
```
  </action>
  <verify>
Run: `mvn compile` - no compilation errors
Run: `grep -r "public record Vec" src/com/mojang/tower` - Vec is a record
Run: `grep -rn "Vec" src/com/mojang/tower --include="*.java" | grep -v Vec.java` - returns empty (no other file uses Vec)
Run: `mvn test -Dtest=GoldenMasterTest` - golden master still passes
  </verify>
  <done>Vec is a record with value semantics. Internal accessor methods used. Golden master passes.</done>
</task>

<task type="auto">
  <name>Task 2: Create Cost record and refactor HouseType</name>
  <files>
    src/com/mojang/tower/Cost.java
    src/com/mojang/tower/HouseType.java
    src/com/mojang/tower/Resources.java
  </files>
  <action>
**Create Cost.java record (LANG-02):**

```java
package com.mojang.tower;

/**
 * Immutable record representing building costs.
 * Replaces the wood/rock/food fields previously scattered in HouseType.
 */
public record Cost(int wood, int rock, int food) {

    /**
     * Check if resources can cover this cost.
     */
    public boolean canAfford(Resources resources) {
        return resources.wood >= wood
            && resources.rock >= rock
            && resources.food >= food;
    }

    /**
     * Deduct this cost from resources.
     */
    public void chargeFrom(Resources resources) {
        resources.wood -= wood;
        resources.rock -= rock;
        resources.food -= food;
    }
}
```

**Refactor HouseType.java to use Cost:**

1. Replace individual wood/rock/food fields with Cost record:
```java
// BEFORE:
public final int wood, rock, food;

// AFTER:
public final Cost cost;
```

2. Update constructor:
```java
// BEFORE:
private HouseType(int image, String name, int radius, int wood, int rock, int food) {
    ...
    this.wood = wood;
    this.rock = rock;
    this.food = food;
    ...
}

// AFTER:
private HouseType(int image, String name, int radius, int wood, int rock, int food) {
    ...
    this.cost = new Cost(wood, rock, food);
    ...
}
```

3. Update getString() method to use cost accessors:
```java
// BEFORE:
if (wood > 0) res += " wood:" + wood;
if (rock > 0) res += " rock:" + rock;
if (food > 0) res += " food:" + food;

// AFTER:
if (cost.wood() > 0) res += " wood:" + cost.wood();
if (cost.rock() > 0) res += " rock:" + cost.rock();
if (cost.food() > 0) res += " food:" + cost.food();
```

**Refactor Resources.java to use Cost:**

1. Update charge() method:
```java
// BEFORE:
public void charge(HouseType type) {
    wood -= type.wood;
    rock -= type.rock;
    food -= type.food;
}

// AFTER:
public void charge(HouseType type) {
    type.cost.chargeFrom(this);
}
```

2. Update canAfford() method:
```java
// BEFORE:
public boolean canAfford(HouseType type) {
    if (wood < type.wood) return false;
    if (rock < type.rock) return false;
    if (food < type.food) return false;
    return true;
}

// AFTER:
public boolean canAfford(HouseType type) {
    return type.cost.canAfford(this);
}
```

**Compile and test after changes:**
```bash
mvn compile
mvn test -Dtest=GoldenMasterTest
```
  </action>
  <verify>
Run: `mvn compile` - no compilation errors
Run: `grep -r "public record Cost" src/com/mojang/tower` - Cost record exists
Run: `grep "Cost cost" src/com/mojang/tower/HouseType.java` - HouseType uses Cost
Run: `mvn test -Dtest=GoldenMasterTest` - golden master still passes
  </verify>
  <done>Cost record created. HouseType and Resources refactored to use Cost. Golden master passes. LANG-02 satisfied.</done>
</task>

<task type="auto">
  <name>Task 3: Apply pattern matching, switch expressions, and var</name>
  <files>
    src/com/mojang/tower/Peon.java
    src/com/mojang/tower/Monster.java
    src/com/mojang/tower/House.java
    src/com/mojang/tower/Job.java
    src/com/mojang/tower/TowerComponent.java
    src/com/mojang/tower/Resources.java
    src/com/mojang/tower/Island.java
    src/com/mojang/tower/Bitmaps.java
    src/com/mojang/tower/Tree.java
    src/com/mojang/tower/Rock.java
    src/com/mojang/tower/FarmPlot.java
    src/com/mojang/tower/Sound.java
    src/com/mojang/tower/Sounds.java
  </files>
  <action>
**Pattern Matching for instanceof (12 locations identified):**

Convert all `instanceof X` followed by cast to pattern matching:

Peon.java (lines 80, 86, 90, 103):
```java
// Line 90: BEFORE: if (e instanceof Monster) { setJob(new Job.Hunt((Monster) e)); }
// AFTER:
if (e instanceof Monster monster) {
    setJob(new Job.Hunt(monster));
}

// Line 103: if (!(target instanceof Tree)) - no cast needed, leave as is
```

House.java (lines 122, 202, 207):
```java
// Line 202: BEFORE: return e.isAlive() && (e instanceof Peon) && (!mustBeFree || ((Peon) e).job == null);
// AFTER - use pattern matching in lambda:
// Note: Pattern variables don't work well in complex boolean expressions, may need to restructure

// Line 207: BEFORE: if (e instanceof Peon) { Peon peon = (Peon) e; ... }
// AFTER:
if (e instanceof Peon peon) {
    // use peon directly
}
```

TowerComponent.java (lines 287, 467):
```java
// These are type checks without casts - leave as is:
// return e instanceof House;
```

Monster.java (lines 51, 54):
```java
// These are type checks without casts - leave as is:
// e instanceof House || e instanceof Peon
```

Job.java (line 70):
```java
// Type check without cast - leave as is:
// return e instanceof Monster;
```

**Switch Expression in Resources.java:**

```java
// BEFORE:
public void add(int resourceId, int count) {
    switch(resourceId) {
        case WOOD: wood+=count; break;
        case ROCK: rock+=count; break;
        case FOOD: food+=count; break;
    }
}

// AFTER:
public void add(int resourceId, int count) {
    switch (resourceId) {
        case WOOD -> wood += count;
        case ROCK -> rock += count;
        case FOOD -> food += count;
        default -> {} // silently ignore invalid resourceId (matches original behavior)
    }
}
```

**var usage (conservative - only where type obvious):**

Apply var where type is obvious from RHS (new, literals, factory methods):
```java
// GOOD examples:
var mapper = new ObjectMapper();
var monster = new Monster(x, y);
var entities = new ArrayList<Entity>();
var count = 0;

// AVOID - type not obvious:
// var e = island.getEntityAt(x, y, r, filter);  // Keep explicit type
```

Sweep through files systematically:
- Island.java: `new Random`, `new ArrayList<Entity>`, `new House`, `new Peon`, etc.
- TowerComponent.java: `new BufferStrategy`, etc.
- Bitmaps.java: `new BufferedImage`, etc.

**Compile and test after each file change:**
Run `mvn compile && mvn test -Dtest=GoldenMasterTest` after each file.
If golden master fails, investigate immediately - don't proceed until fixed.
  </action>
  <verify>
Run: `mvn compile` - no compilation errors
Run: `grep -rn "instanceof [A-Z]" src/com/mojang/tower --include="*.java"` - verify all instanceof usages reviewed (pattern matching applied where cast follows)
Run: `grep -rn "instanceof.*) {" src/com/mojang/tower --include="*.java" | grep -v "//"` - should show pattern matching where applicable
Run: `grep -n "case.*->" src/com/mojang/tower/Resources.java` - switch expression syntax present
Run: `mvn test -Dtest=GoldenMasterTest` - golden master passes (behavior preserved)
  </verify>
  <done>Pattern matching, switch expressions, and var applied throughout codebase. Golden master confirms behavior unchanged.</done>
</task>

</tasks>

<verification>
1. Vec.java declares `public record Vec`
2. Cost.java declares `public record Cost` with wood, rock, food components
3. HouseType.java uses `Cost cost` field instead of separate wood/rock/food fields
4. Resources.add() uses switch expression with `->` syntax
5. All instanceof+cast patterns use pattern matching
6. `var` used conservatively where type obvious
7. `mvn test` passes - golden master verification succeeds
8. `mvn compile` has no warnings about deprecated patterns
9. Verify no other files use Vec: `grep -rn "Vec" src/com/mojang/tower --include="*.java" | grep -v Vec.java` returns empty
</verification>

<success_criteria>
- Vec is a Java record with automatic equals/hashCode
- Cost is a Java record representing building costs (LANG-02 satisfied)
- HouseType uses Cost record for wood/rock/food costs
- Resources uses Cost for charge() and canAfford() methods
- Pattern matching used for all instanceof+cast patterns
- Resources.add() uses switch expression
- var used for obvious type declarations
- `mvn test -Dtest=GoldenMasterTest` passes (behavior preserved)
- Code compiles cleanly with Java 21
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-language-modernization/01-03-SUMMARY.md`
</output>
