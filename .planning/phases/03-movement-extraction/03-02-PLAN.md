---
phase: 03-movement-extraction
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/main/java/com/mojang/tower/Peon.java
autonomous: true

must_haves:
  truths:
    - "Peon movement uses MovementSystem instead of inline position updates"
    - "Peon collision handling preserved (job.collide, job.cantReach, rotation change)"
    - "Peon wanderTime behavior preserved after collision"
    - "Golden master test passes (exact behavior preserved)"
  artifacts:
    - path: "src/main/java/com/mojang/tower/Peon.java"
      provides: "Peon with MovementSystem integration"
      contains: "ServiceLocator.movement().move"
  key_links:
    - from: "src/main/java/com/mojang/tower/Peon.java"
      to: "MovementSystem.move()"
      via: "ServiceLocator.movement()"
      pattern: "ServiceLocator\\.movement\\(\\)\\.move"
    - from: "src/main/java/com/mojang/tower/Peon.java"
      to: "MovementResult handling"
      via: "switch expression on result"
      pattern: "case MovementResult\\."
---

<objective>
Extract Peon movement execution to use MovementSystem.

Purpose: Decouple movement execution from Peon behavior logic. This is the more complex of the two extractions due to job callbacks (collide, cantReach) on collision.

Output: Peon.tick() uses MovementSystem for movement while preserving exact collision handling behavior.
</objective>

<execution_context>
@/home/docinhos/.claude/get-shit-done/workflows/execute-plan.md
@/home/docinhos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-movement-extraction/03-RESEARCH.md
@.planning/phases/03-movement-extraction/03-01-SUMMARY.md

Reference files:
@src/main/java/com/mojang/tower/Peon.java
@src/main/java/com/mojang/tower/movement/MovementSystem.java
@src/main/java/com/mojang/tower/movement/MovementRequest.java
@src/main/java/com/mojang/tower/movement/MovementResult.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor Peon.tick() to use MovementSystem</name>
  <files>src/main/java/com/mojang/tower/Peon.java</files>
  <action>
Refactor the movement section of Peon.tick() (lines ~137-161) to use MovementSystem.

**CRITICAL: Preserve exact behavior.** The collision handling must remain identical to pass golden master.

**Current code to replace (lines 137-161):**
```java
double xt = x + Math.cos(rot) * 0.4 * speed;
double yt = y + Math.sin(rot) * 0.4 * speed;
if (island.isFree(xt, yt, r, this))
{
    x = xt;
    y = yt;
}
else
{
    if (job != null)
    {
        Entity collided = island.getEntityAt(xt, yt, r, null, this);
        if (collided != null)
        {
            job.collide(collided);
        }
        else
        {
            job.cantReach();
        }
    }
    rot = (random.nextDouble())*Math.PI*2;
    wanderTime = random.nextInt(30)+3;
}
```

**Replace with:**
```java
double targetX = x + Math.cos(rot) * 0.4 * speed;
double targetY = y + Math.sin(rot) * 0.4 * speed;
MovementResult result = ServiceLocator.movement().move(
    new MovementRequest(this, targetX, targetY)
);
switch (result) {
    case MovementResult.Moved(var newX, var newY) -> {
        // Position already updated by MovementSystem
    }
    case MovementResult.Blocked(var blocker) -> {
        if (job != null) {
            if (blocker != null) {
                job.collide(blocker);
            } else {
                job.cantReach();
            }
        }
        rot = random.nextDouble() * Math.PI * 2;
        wanderTime = random.nextInt(30) + 3;
    }
}
```

**Add imports at top of file:**
```java
import com.mojang.tower.movement.MovementRequest;
import com.mojang.tower.movement.MovementResult;
import com.mojang.tower.service.ServiceLocator;
```

Note: ServiceLocator import may already exist from Phase 2 - check before adding duplicate.

**Key preservation points:**
1. Target position calculation: `Math.cos(rot) * 0.4 * speed` - unchanged
2. Collision response: job.collide(blocker) when blocker exists, job.cantReach() when blocked by terrain
3. Rotation randomization: `random.nextDouble() * Math.PI * 2` - same formula
4. wanderTime assignment: `random.nextInt(30) + 3` - same formula

**What NOT to change:**
- Speed calculation (`speed += level * 0.1`)
- Rotation calculation before movement
- wanderTime decrement
- moveTick increment (animation)
- Anything outside the position update block
  </action>
  <verify>
1. `mvn compile -q` succeeds
2. `mvn test` passes - golden master MUST pass
3. Visual inspection: Peon.tick() uses MovementSystem for movement
  </verify>
  <done>
Peon.tick() uses MovementSystem.move() for movement execution.
Collision handling preserved: job callbacks and rotation/wanderTime changes.
Golden master passes confirming exact behavior preservation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify behavior preservation</name>
  <files>N/A - verification only</files>
  <action>
Run the game manually for quick visual verification:

```bash
cd /home/docinhos/Documents/Java/BreakingTheTower
mvn exec:java -Dexec.mainClass="com.mojang.tower.TowerComponent" -q
```

Observe for ~30 seconds:
1. Peons move around normally
2. Peons respond to obstacles (trees, rocks, other peons)
3. Peons gather resources and return to base
4. Warriors hunt monsters

If any abnormal behavior:
- Peons stuck in place
- Peons walking through obstacles
- Peons ignoring targets

Then the refactor broke behavior - review the switch expression implementation.

After verification, close the game window.
  </action>
  <verify>Manual visual verification that peon behavior appears normal</verify>
  <done>Peons behave identically to pre-refactor: move, collide, gather, hunt</done>
</task>

</tasks>

<verification>
1. Peon.java imports MovementRequest, MovementResult, ServiceLocator
2. Peon.tick() contains `ServiceLocator.movement().move(`
3. Peon.tick() contains switch on MovementResult
4. No inline `x = xt; y = yt;` position update in Peon.tick() (moved to MovementSystem)
5. `mvn compile` succeeds
6. `mvn test` passes (golden master)
</verification>

<success_criteria>
- Peon movement execution delegated to MovementSystem
- All collision handling (job callbacks, rotation, wanderTime) preserved
- Golden master test passes
- Visual verification confirms normal peon behavior
</success_criteria>

<output>
After completion, create `.planning/phases/03-movement-extraction/03-02-SUMMARY.md`
</output>
