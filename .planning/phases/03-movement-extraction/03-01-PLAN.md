---
phase: 03-movement-extraction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/java/com/mojang/tower/movement/MovementRequest.java
  - src/main/java/com/mojang/tower/movement/MovementResult.java
  - src/main/java/com/mojang/tower/movement/MovementSystem.java
  - src/main/java/com/mojang/tower/service/ServiceLocator.java
  - src/main/java/com/mojang/tower/TowerComponent.java
autonomous: true

must_haves:
  truths:
    - "MovementSystem can be accessed via ServiceLocator.movement()"
    - "MovementRequest captures entity and target position"
    - "MovementResult.Moved indicates successful position update"
    - "MovementResult.Blocked provides blocker entity reference"
    - "Project compiles successfully"
  artifacts:
    - path: "src/main/java/com/mojang/tower/movement/MovementRequest.java"
      provides: "Movement request record with factory method"
      contains: "record MovementRequest"
    - path: "src/main/java/com/mojang/tower/movement/MovementResult.java"
      provides: "Sealed interface for movement outcomes"
      contains: "sealed interface MovementResult"
    - path: "src/main/java/com/mojang/tower/movement/MovementSystem.java"
      provides: "Movement execution service"
      contains: "public MovementResult move"
    - path: "src/main/java/com/mojang/tower/service/ServiceLocator.java"
      provides: "Movement service registration"
      contains: "MovementSystem movement()"
  key_links:
    - from: "src/main/java/com/mojang/tower/movement/MovementSystem.java"
      to: "Island.isFree()"
      via: "collision detection delegation"
      pattern: "island\\.isFree"
    - from: "src/main/java/com/mojang/tower/TowerComponent.java"
      to: "ServiceLocator.provide(MovementSystem)"
      via: "service registration in init()"
      pattern: "ServiceLocator\\.provide.*MovementSystem"
---

<objective>
Create MovementSystem infrastructure for entity movement execution.

Purpose: Establish the service and data structures that will decouple movement execution from entity behavior, following the existing ServiceLocator pattern from Phase 2.

Output: MovementSystem service registered in ServiceLocator, MovementRequest/MovementResult records ready for use by Peon and Monster.
</objective>

<execution_context>
@/home/docinhos/.claude/get-shit-done/workflows/execute-plan.md
@/home/docinhos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-movement-extraction/03-RESEARCH.md

Reference files:
@src/main/java/com/mojang/tower/service/ServiceLocator.java
@src/main/java/com/mojang/tower/Island.java
@src/main/java/com/mojang/tower/TowerComponent.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MovementRequest record</name>
  <files>src/main/java/com/mojang/tower/movement/MovementRequest.java</files>
  <action>
Create the MovementRequest record in a new `movement` package:

```java
package com.mojang.tower.movement;

import com.mojang.tower.Entity;

/**
 * Request for entity movement to a target position.
 * Contains the entity to move and the target coordinates.
 */
public record MovementRequest(
    Entity entity,
    double targetX,
    double targetY
) {
    /**
     * Factory: create request from entity moving in direction at speed.
     * Calculates target position based on current position, direction, and speed.
     */
    public static MovementRequest fromDirection(Entity entity, double direction, double speed) {
        double targetX = entity.x + Math.cos(direction) * speed;
        double targetY = entity.y + Math.sin(direction) * speed;
        return new MovementRequest(entity, targetX, targetY);
    }
}
```

This follows the record pattern established in Phase 1 (Vec, Cost) and provides a clean API for movement requests.
  </action>
  <verify>File exists and compiles: `mvn compile -q` succeeds</verify>
  <done>MovementRequest record exists with entity, targetX, targetY fields and fromDirection factory method</done>
</task>

<task type="auto">
  <name>Task 2: Create MovementResult sealed interface</name>
  <files>src/main/java/com/mojang/tower/movement/MovementResult.java</files>
  <action>
Create the MovementResult sealed interface with Moved and Blocked record implementations:

```java
package com.mojang.tower.movement;

import com.mojang.tower.Entity;

/**
 * Result of a movement attempt.
 * Sealed interface enables exhaustive pattern matching in switch expressions.
 */
public sealed interface MovementResult permits MovementResult.Moved, MovementResult.Blocked {
    /**
     * Movement succeeded. Entity position has been updated.
     */
    record Moved(double x, double y) implements MovementResult {}

    /**
     * Movement blocked by collision. Entity position unchanged.
     * @param blocker the blocking entity, or null if blocked by terrain/boundary
     */
    record Blocked(Entity blocker) implements MovementResult {}
}
```

This follows the sealed interface pattern established in Phase 2 (GameState, SoundEvent, EffectEvent).
  </action>
  <verify>File exists and compiles: `mvn compile -q` succeeds</verify>
  <done>MovementResult sealed interface exists with Moved and Blocked record implementations</done>
</task>

<task type="auto">
  <name>Task 3: Create MovementSystem service and integrate with ServiceLocator</name>
  <files>
    src/main/java/com/mojang/tower/movement/MovementSystem.java
    src/main/java/com/mojang/tower/service/ServiceLocator.java
    src/main/java/com/mojang/tower/TowerComponent.java
  </files>
  <action>
**Step 1:** Create MovementSystem class:

```java
package com.mojang.tower.movement;

import com.mojang.tower.Entity;
import com.mojang.tower.Island;

/**
 * Central service for entity movement execution.
 * Handles collision detection and position updates.
 * Entities calculate their movement intent; this system executes it.
 */
public final class MovementSystem {
    private Island island;

    /**
     * Set the Island reference for collision detection.
     * Must be called before any move() calls.
     */
    public void setIsland(Island island) {
        this.island = island;
    }

    /**
     * Execute a movement request with collision detection.
     * If movement succeeds, updates entity position and returns Moved.
     * If blocked, position unchanged and returns Blocked with blocker reference.
     *
     * @param request the movement request containing entity and target position
     * @return MovementResult indicating success or blocking entity
     * @throws IllegalStateException if island not set
     */
    public MovementResult move(MovementRequest request) {
        if (island == null) {
            throw new IllegalStateException("MovementSystem.island not initialized. Call setIsland() first.");
        }

        Entity entity = request.entity();
        double targetX = request.targetX();
        double targetY = request.targetY();

        if (island.isFree(targetX, targetY, entity.r, entity)) {
            entity.x = targetX;
            entity.y = targetY;
            return new MovementResult.Moved(targetX, targetY);
        } else {
            Entity blocker = island.getEntityAt(targetX, targetY, entity.r, null, entity);
            return new MovementResult.Blocked(blocker);
        }
    }
}
```

**Step 2:** Extend ServiceLocator to support MovementSystem:

Add to ServiceLocator.java:
- Add field: `private static MovementSystem movementSystem;`
- Add provide method: `public static void provide(MovementSystem service)`
- Add accessor: `public static MovementSystem movement()` with null check
- Update reset(): add `movementSystem = null;`

**Step 3:** Initialize MovementSystem in TowerComponent.init():

After the line `island = new Island(this, bitmaps.island);` add:
```java
// Initialize MovementSystem
var movementSystem = new MovementSystem();
movementSystem.setIsland(island);
ServiceLocator.provide(movementSystem);
```

Add import: `import com.mojang.tower.movement.MovementSystem;`

IMPORTANT: MovementSystem initialization MUST come after Island creation since it needs the Island reference.
  </action>
  <verify>
1. `mvn compile -q` succeeds
2. `mvn test -q` passes (golden master should still pass - no behavior change yet)
  </verify>
  <done>
MovementSystem service created and registered via ServiceLocator.
ServiceLocator.movement() returns the initialized service.
TowerComponent.init() creates and registers MovementSystem after Island creation.
  </done>
</task>

</tasks>

<verification>
1. All three new files exist in movement package:
   - MovementRequest.java (record)
   - MovementResult.java (sealed interface)
   - MovementSystem.java (service class)

2. ServiceLocator has movement() accessor

3. TowerComponent.init() registers MovementSystem

4. Project compiles: `mvn compile`

5. Golden master test passes: `mvn test` (no behavior change yet - infrastructure only)
</verification>

<success_criteria>
- MovementSystem infrastructure complete and accessible via ServiceLocator
- No changes to game behavior (golden master passes)
- Ready for Plan 02 (Peon) and Plan 03 (Monster) to use MovementSystem
</success_criteria>

<output>
After completion, create `.planning/phases/03-movement-extraction/03-01-SUMMARY.md`
</output>
