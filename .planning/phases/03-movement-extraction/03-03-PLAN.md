---
phase: 03-movement-extraction
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - src/main/java/com/mojang/tower/Monster.java
autonomous: true

must_haves:
  truths:
    - "Monster movement uses MovementSystem instead of inline position updates"
    - "Monster collision handling preserved (rotation change, wanderTime)"
    - "Golden master test passes (exact behavior preserved)"
    - "Monster still hunts peons and houses correctly"
  artifacts:
    - path: "src/main/java/com/mojang/tower/Monster.java"
      provides: "Monster with MovementSystem integration"
      contains: "ServiceLocator.movement().move"
  key_links:
    - from: "src/main/java/com/mojang/tower/Monster.java"
      to: "MovementSystem.move()"
      via: "ServiceLocator.movement()"
      pattern: "ServiceLocator\\.movement\\(\\)\\.move"
    - from: "src/main/java/com/mojang/tower/Monster.java"
      to: "MovementResult handling"
      via: "instanceof check or switch"
      pattern: "MovementResult\\.Blocked"
---

<objective>
Extract Monster movement execution to use MovementSystem.

Purpose: Complete movement extraction by migrating Monster to MovementSystem. This is simpler than Peon since Monster has no job callbacks - just rotation change on collision.

Output: Monster.tick() uses MovementSystem for movement while preserving collision handling behavior.
</objective>

<execution_context>
@/home/docinhos/.claude/get-shit-done/workflows/execute-plan.md
@/home/docinhos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-movement-extraction/03-RESEARCH.md
@.planning/phases/03-movement-extraction/03-01-SUMMARY.md
@.planning/phases/03-movement-extraction/03-02-SUMMARY.md

Reference files:
@src/main/java/com/mojang/tower/Monster.java
@src/main/java/com/mojang/tower/Peon.java (for reference - similar pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor Monster.tick() to use MovementSystem</name>
  <files>src/main/java/com/mojang/tower/Monster.java</files>
  <action>
Refactor the movement section of Monster.tick() (lines ~84-95) to use MovementSystem.

**CRITICAL: Preserve exact behavior.** The collision rotation formula must be identical.

**Current code to replace (lines 84-95):**
```java
double xt = x + Math.cos(rot) * 0.3 * speed;
double yt = y + Math.sin(rot) * 0.3 * speed;
if (island.isFree(xt, yt, r, this))
{
    x = xt;
    y = yt;
}
else
{
    rot += random.nextInt(2) * 2 - 1 * Math.PI / 2 + (random.nextDouble() - 0.5);
    wanderTime = random.nextInt(30);
}
```

**Replace with:**
```java
double targetX = x + Math.cos(rot) * 0.3 * speed;
double targetY = y + Math.sin(rot) * 0.3 * speed;
MovementResult result = ServiceLocator.movement().move(
    new MovementRequest(this, targetX, targetY)
);
if (result instanceof MovementResult.Blocked) {
    rot += random.nextInt(2) * 2 - 1 * Math.PI / 2 + (random.nextDouble() - 0.5);
    wanderTime = random.nextInt(30);
}
```

Note: Using `instanceof` check instead of switch since we only care about Blocked case. This matches the research recommendation for simpler Monster handling.

**Add imports at top of file:**
```java
import com.mojang.tower.movement.MovementRequest;
import com.mojang.tower.movement.MovementResult;
import com.mojang.tower.service.ServiceLocator;
```

**Key preservation points:**
1. Target position calculation: `Math.cos(rot) * 0.3 * speed` - unchanged (note: 0.3 not 0.4 like Peon)
2. Collision rotation: `random.nextInt(2) * 2 - 1 * Math.PI / 2 + (random.nextDouble() - 0.5)` - exact formula
3. wanderTime: `random.nextInt(30)` - no +3 like Peon

**What NOT to change:**
- Speed calculation
- Target tracking and rotation toward target
- wanderTime decrement
- moveTick increment (animation)
- fight() behavior
- Anything outside the position update block
  </action>
  <verify>
1. `mvn compile -q` succeeds
2. `mvn test` passes - golden master MUST pass
3. Visual inspection: Monster.tick() uses MovementSystem for movement
  </verify>
  <done>
Monster.tick() uses MovementSystem.move() for movement execution.
Collision rotation formula preserved exactly.
Golden master passes confirming exact behavior preservation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Final verification and phase completion</name>
  <files>N/A - verification only</files>
  <action>
Run full verification suite:

1. **Compile check:**
```bash
mvn compile -q
```

2. **Golden master test:**
```bash
mvn test
```

3. **Manual play test:**
```bash
mvn exec:java -Dexec.mainClass="com.mojang.tower.TowerComponent" -q
```

Observe for ~60 seconds to verify:
- Peons move, gather, build, hunt normally
- Warriors engage monsters
- Monsters spawn, hunt peons/houses, fight back
- Collision behavior looks natural (no getting stuck, no walking through)
- Overall game feels identical to before Phase 3

4. **Code verification - confirm MovementSystem is single source of truth:**
```bash
# Should find MovementSystem usage in Peon and Monster
grep -r "ServiceLocator.movement()" src/main/java/com/mojang/tower/

# Should NOT find direct position updates in Peon.tick() or Monster.tick() movement sections
# (There may still be direct x/y assignments elsewhere, like spawn positions - that's OK)
```
  </action>
  <verify>
1. `mvn test` passes
2. Manual play confirms normal behavior
3. grep confirms MovementSystem used in both Peon and Monster
  </verify>
  <done>
Phase 3 complete: MovementSystem is the single source of truth for Peon and Monster movement.
Golden master passes, confirming exact behavior preservation.
Movement execution decoupled from behavior logic - ready for future pathfinding integration.
  </done>
</task>

</tasks>

<verification>
1. Monster.java imports MovementRequest, MovementResult, ServiceLocator
2. Monster.tick() contains `ServiceLocator.movement().move(`
3. Monster.tick() contains `instanceof MovementResult.Blocked` check
4. No inline `x = xt; y = yt;` position update in Monster.tick() (moved to MovementSystem)
5. `mvn compile` succeeds
6. `mvn test` passes (golden master)

**Phase 3 completion verification:**
- All 5 success criteria from ROADMAP.md are met:
  1. MovementSystem exists as single source of truth for entity movement
  2. Peon movement logic lives in MovementSystem, not in Peon.tick()
  3. Monster movement logic lives in MovementSystem, not in Monster.tick()
  4. Jobs request movement via MovementSystem instead of directly updating positions
  5. Golden master tests still pass (behavior preserved)
</verification>

<success_criteria>
- Monster movement execution delegated to MovementSystem
- All collision handling (rotation, wanderTime) preserved
- Golden master test passes
- Phase 3 requirements (ARCH-01, ARCH-02, ARCH-03, ARCH-04) satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/03-movement-extraction/03-03-SUMMARY.md`
</output>
