---
phase: 02-decoupling-systems
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/java/com/mojang/tower/event/EventBus.java
  - src/main/java/com/mojang/tower/event/SoundEvent.java
  - src/main/java/com/mojang/tower/service/ServiceLocator.java
  - src/main/java/com/mojang/tower/service/AudioService.java
  - src/main/java/com/mojang/tower/service/SoundsAdapter.java
  - src/main/java/com/mojang/tower/service/NullAudioService.java
  - src/main/java/com/mojang/tower/House.java
  - src/main/java/com/mojang/tower/Peon.java
  - src/main/java/com/mojang/tower/Monster.java
  - src/main/java/com/mojang/tower/Job.java
  - src/main/java/com/mojang/tower/Island.java
  - src/main/java/com/mojang/tower/TowerComponent.java
autonomous: true

must_haves:
  truths:
    - "Sound effects still play when game actions occur"
    - "No direct Sounds.play() calls remain in entity/job classes"
    - "Sound system can be muted/unmuted via existing UI button"
    - "Golden master tests still pass (deterministic behavior preserved)"
  artifacts:
    - path: "src/main/java/com/mojang/tower/event/EventBus.java"
      provides: "Publish/subscribe hub for events"
      exports: ["subscribe", "publish", "reset"]
    - path: "src/main/java/com/mojang/tower/event/SoundEvent.java"
      provides: "Sealed interface with all sound event records"
      contains: "sealed interface SoundEvent"
    - path: "src/main/java/com/mojang/tower/service/ServiceLocator.java"
      provides: "Central registry for services"
      exports: ["provide", "audio", "reset"]
    - path: "src/main/java/com/mojang/tower/service/AudioService.java"
      provides: "Interface abstracting Sounds singleton"
      exports: ["play", "setMute", "isMute"]
  key_links:
    - from: "House.java, Peon.java, Monster.java, Job.java, Island.java"
      to: "EventBus"
      via: "EventBus.publish(new XxxSound())"
      pattern: "EventBus\\.publish\\(new \\w+Sound"
    - from: "TowerComponent.java"
      to: "ServiceLocator.audio()"
      via: "Sound event handler"
      pattern: "ServiceLocator\\.audio\\(\\)\\.play"
---

<objective>
Create EventBus and ServiceLocator infrastructure, then replace all direct Sounds.play() calls with event publishing.

Purpose: Decouple entity classes from sound system - entities publish events, handlers translate to sound playback. This enables testability and prepares for further decoupling.
Output: EventBus, ServiceLocator, SoundEvent hierarchy, and all 10 Sounds.play() calls replaced with events.
</objective>

<execution_context>
@/home/docinhos/.claude/get-shit-done/workflows/execute-plan.md
@/home/docinhos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-decoupling-systems/02-RESEARCH.md

# Key source files to modify
@src/main/java/com/mojang/tower/Sounds.java
@src/main/java/com/mojang/tower/Sound.java
@src/main/java/com/mojang/tower/TowerComponent.java
@src/main/java/com/mojang/tower/House.java
@src/main/java/com/mojang/tower/Peon.java
@src/main/java/com/mojang/tower/Monster.java
@src/main/java/com/mojang/tower/Job.java
@src/main/java/com/mojang/tower/Island.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create EventBus and ServiceLocator infrastructure</name>
  <files>
    src/main/java/com/mojang/tower/event/EventBus.java
    src/main/java/com/mojang/tower/event/SoundEvent.java
    src/main/java/com/mojang/tower/service/ServiceLocator.java
    src/main/java/com/mojang/tower/service/AudioService.java
    src/main/java/com/mojang/tower/service/SoundsAdapter.java
    src/main/java/com/mojang/tower/service/NullAudioService.java
  </files>
  <action>
Create new packages and classes following the patterns from 02-RESEARCH.md:

**event/EventBus.java:**
- Singleton with static subscribe/publish/reset methods
- Use ConcurrentHashMap for listener registry
- Use CopyOnWriteArrayList for listener lists (thread-safe iteration)
- Synchronous dispatch (no async - critical for game determinism)
- Generic type parameter for type-safe subscription

**event/SoundEvent.java:**
- Sealed interface permitting all sound event records
- Create records for each Sound subclass: SelectSound, PlantSound, DestroySound, GatherSound, FinishBuildingSound, SpawnSound, SpawnWarriorSound, DingSound, DeathSound, MonsterDeathSound, WinSound
- All records are empty (no position data needed - sounds don't need location)

**service/AudioService.java:**
- Interface with methods: play(Sound sound), setMute(boolean mute), isMute()

**service/ServiceLocator.java:**
- Static field for AudioService
- provide(AudioService) to register
- audio() to get service (throws if not initialized)
- reset() to clear for testing
- initializeDefaults() to register SoundsAdapter

**service/SoundsAdapter.java:**
- Implements AudioService
- Wraps existing Sounds singleton
- Delegates play/setMute/isMute to Sounds static methods

**service/NullAudioService.java:**
- Implements AudioService
- No-op implementation for testing (play does nothing, isMute returns true)

IMPORTANT: Do NOT modify existing classes yet - just create the infrastructure.
  </action>
  <verify>
    mvn compile -f /home/docinhos/Documents/Java/BreakingTheTower/pom.xml
  </verify>
  <done>
    - EventBus.java exists with subscribe/publish/reset methods
    - SoundEvent.java exists as sealed interface with 11 sound event records
    - ServiceLocator.java exists with provide/audio/reset/initializeDefaults
    - AudioService.java interface exists
    - SoundsAdapter.java implements AudioService, wraps Sounds
    - NullAudioService.java implements AudioService (no-op)
    - Project compiles with no errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace all Sounds.play() calls with EventBus.publish()</name>
  <files>
    src/main/java/com/mojang/tower/House.java
    src/main/java/com/mojang/tower/Peon.java
    src/main/java/com/mojang/tower/Monster.java
    src/main/java/com/mojang/tower/Job.java
    src/main/java/com/mojang/tower/Island.java
    src/main/java/com/mojang/tower/TowerComponent.java
  </files>
  <action>
Replace direct Sounds.play() calls with EventBus.publish() across all entity/job classes:

**Island.java (line 238):**
- Replace: `Sounds.play(new Sound.Plant());`
- With: `EventBus.publish(new PlantSound());`
- Add import for EventBus and PlantSound

**House.java (lines 37, 64, 80, 178):**
- Replace: `Sounds.play(new Sound.Destroy());` -> `EventBus.publish(new DestroySound());`
- Replace: `Sounds.play(new Sound.Gather());` -> `EventBus.publish(new GatherSound());`
- Replace: `Sounds.play(new Sound.FinishBuilding());` -> `EventBus.publish(new FinishBuildingSound());`
- Replace: `Sounds.play(new Sound.Spawn());` -> `EventBus.publish(new SpawnSound());`
- Add imports, remove Sounds/Sound imports if no longer needed

**Peon.java (lines 58, 215):**
- Replace: `Sounds.play(new Sound.Death());` -> `EventBus.publish(new DeathSound());`
- Replace: `Sounds.play(new Sound.Ding());` -> `EventBus.publish(new DingSound());`
- Add imports

**Monster.java (line 33):**
- Replace: `Sounds.play(new Sound.MonsterDeath());` -> `EventBus.publish(new MonsterDeathSound());`
- Add imports

**Job.java (line 75):**
- Replace: `Sounds.play(new Sound.SpawnWarrior());` -> `EventBus.publish(new SpawnWarriorSound());`
- Add imports

**TowerComponent.java (line 452):**
- Replace: `Sounds.play(new Sound.Select());` -> `EventBus.publish(new SelectSound());`
- Add import for EventBus and SelectSound

After replacements, verify NO Sounds.play() calls remain in entity/job classes (only Sounds.setMute/isMute in TowerComponent for UI button).
  </action>
  <verify>
    grep -r "Sounds\.play" /home/docinhos/Documents/Java/BreakingTheTower/src/main/java/com/mojang/tower/*.java | grep -v "TowerComponent" && echo "FAIL: Sounds.play() still exists in entity/job files" || echo "OK: No Sounds.play() in entity/job files"
  </verify>
  <done>
    - All 10 Sounds.play() calls replaced with EventBus.publish()
    - No Sounds.play() calls in House, Peon, Monster, Job, Island
    - TowerComponent still has Sounds.setMute/isMute for mute button (expected)
    - Project compiles
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire sound event handler and initialize services</name>
  <files>
    src/main/java/com/mojang/tower/TowerComponent.java
  </files>
  <action>
Wire the EventBus to handle sound events and initialize ServiceLocator:

**In TowerComponent.init() method (after bitmaps.loadAll()):**
1. Call ServiceLocator.initializeDefaults() to register SoundsAdapter
2. Subscribe to SoundEvent.class with a handler method

**Add handler method (private):**
```java
private void handleSoundEvent(SoundEvent event) {
    Sound sound = switch (event) {
        case SelectSound() -> new Sound.Select();
        case PlantSound() -> new Sound.Plant();
        case DestroySound() -> new Sound.Destroy();
        case GatherSound() -> new Sound.Gather();
        case FinishBuildingSound() -> new Sound.FinishBuilding();
        case SpawnSound() -> new Sound.Spawn();
        case SpawnWarriorSound() -> new Sound.SpawnWarrior();
        case DingSound() -> new Sound.Ding();
        case DeathSound() -> new Sound.Death();
        case MonsterDeathSound() -> new Sound.MonsterDeath();
        case WinSound() -> new Sound.WinSound();
    };
    ServiceLocator.audio().play(sound);
}
```

**In TowerComponent.init():**
```java
ServiceLocator.initializeDefaults();
EventBus.subscribe(SoundEvent.class, this::handleSoundEvent);
```

**Update renderGame() method:**
- Replace: `Sounds.isMute()` -> `ServiceLocator.audio().isMute()`

**Update mousePressed() method:**
- Replace: `Sounds.setMute(!Sounds.isMute())` -> `ServiceLocator.audio().setMute(!ServiceLocator.audio().isMute())`

Add all necessary imports for EventBus, SoundEvent records, ServiceLocator, Sound.
  </action>
  <verify>
    cd /home/docinhos/Documents/Java/BreakingTheTower && mvn test -Dtest=GoldenMasterTest -q
  </verify>
  <done>
    - ServiceLocator initialized in TowerComponent.init()
    - EventBus subscribed to SoundEvent with handler
    - Handler uses switch expression with pattern matching on sealed SoundEvent
    - Mute button uses ServiceLocator.audio() instead of direct Sounds calls
    - Golden master test passes (behavior preserved)
  </done>
</task>

</tasks>

<verification>
1. `mvn compile` passes - all new classes compile correctly
2. `grep -r "Sounds\.play" src/main/java/com/mojang/tower/*.java` returns only references in Sounds.java itself
3. `mvn test -Dtest=GoldenMasterTest` passes - deterministic behavior preserved
4. Manual test: Run game, verify sounds play on:
   - Building selection (click building icon)
   - Planting trees (peon plants sapling)
   - Building construction (farm/house completes)
   - Resource gathering (peon deposits resource)
   - Peon death (killed by monster)
   - Monster death (killed by warrior)
</verification>

<success_criteria>
- EventBus and ServiceLocator infrastructure exists and compiles
- All 10 Sounds.play() calls in entity/job classes replaced with EventBus.publish()
- TowerComponent wires handlers and initializes services
- Mute button works via ServiceLocator
- Golden master test passes (CRITICAL - behavior must be preserved)
- No regressions in sound playback during gameplay
</success_criteria>

<output>
After completion, create `.planning/phases/02-decoupling-systems/02-01-SUMMARY.md`
</output>
