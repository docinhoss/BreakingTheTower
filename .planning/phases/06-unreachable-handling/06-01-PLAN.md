---
phase: 06-unreachable-handling
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/java/com/mojang/tower/event/AbandonedTargetSound.java
  - src/main/java/com/mojang/tower/event/SoundEvent.java
  - src/main/java/com/mojang/tower/pathfinding/PathfindingService.java
  - src/main/java/com/mojang/tower/pathfinding/AStarPathfinder.java
  - src/main/java/com/mojang/tower/Job.java
autonomous: true

must_haves:
  truths:
    - "Node limit is configurable through PathfindingService (default 1024)"
    - "Job.target is accessible via getTarget() for blacklist operations"
    - "AbandonedTargetSound event can be published through EventBus"
  artifacts:
    - path: "src/main/java/com/mojang/tower/event/AbandonedTargetSound.java"
      provides: "Event record for target abandonment"
      contains: "record AbandonedTargetSound"
    - path: "src/main/java/com/mojang/tower/pathfinding/PathfindingService.java"
      provides: "Configurable node limit"
      contains: "setMaxNodes"
    - path: "src/main/java/com/mojang/tower/Job.java"
      provides: "Target accessor for blacklisting"
      contains: "getTarget()"
  key_links:
    - from: "src/main/java/com/mojang/tower/event/AbandonedTargetSound.java"
      to: "src/main/java/com/mojang/tower/event/SoundEvent.java"
      via: "implements sealed interface"
      pattern: "permits.*AbandonedTargetSound"
    - from: "src/main/java/com/mojang/tower/pathfinding/PathfindingService.java"
      to: "src/main/java/com/mojang/tower/pathfinding/AStarPathfinder.java"
      via: "passes maxNodes parameter"
      pattern: "findPath.*maxNodes"
---

<objective>
Add infrastructure for unreachable handling: configurable node limit, Job target accessor, and abandonment event.

Purpose: Enable Peon to track failed targets and emit events when abandoning unreachable targets. The node limit (1024) prevents unbounded A* exploration per phase context decision.
Output: AbandonedTargetSound event, configurable PathfindingService, Job.getTarget() accessor
</objective>

<execution_context>
@/home/docinhos/.claude/get-shit-done/workflows/execute-plan.md
@/home/docinhos/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-unreachable-handling/06-CONTEXT.md
@.planning/phases/06-unreachable-handling/06-RESEARCH.md
@src/main/java/com/mojang/tower/event/SoundEvent.java
@src/main/java/com/mojang/tower/pathfinding/PathfindingService.java
@src/main/java/com/mojang/tower/pathfinding/AStarPathfinder.java
@src/main/java/com/mojang/tower/Job.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AbandonedTargetSound event and update SoundEvent permits</name>
  <files>
    src/main/java/com/mojang/tower/event/AbandonedTargetSound.java
    src/main/java/com/mojang/tower/event/SoundEvent.java
  </files>
  <action>
    1. Create new file AbandonedTargetSound.java following existing SoundEvent record pattern (see DeathSound.java):
       ```java
       package com.mojang.tower.event;

       /** Triggered when a peon abandons an unreachable target. */
       public record AbandonedTargetSound() implements SoundEvent {}
       ```

    2. Update SoundEvent.java permits clause to include AbandonedTargetSound:
       - Add AbandonedTargetSound to the permits list (alphabetically after WinSound, or at end)
       - Pattern: `permits ..., WinSound, AbandonedTargetSound {`

    Note: This event enables future sound hooks when peons abandon targets. Per phase context, no actual sound file is required yet.
  </action>
  <verify>
    Run: `mvn compile -q` - no compilation errors
    Verify: AbandonedTargetSound.java exists and SoundEvent permits it
  </verify>
  <done>
    AbandonedTargetSound record exists, implements SoundEvent, compiles without error
  </done>
</task>

<task type="auto">
  <name>Task 2: Make node limit configurable in PathfindingService and AStarPathfinder</name>
  <files>
    src/main/java/com/mojang/tower/pathfinding/AStarPathfinder.java
    src/main/java/com/mojang/tower/pathfinding/PathfindingService.java
  </files>
  <action>
    1. Modify AStarPathfinder.java:
       - Change MAX_NODES constant from 1000 to default value holder
       - Add maxNodes parameter to findPath method signature:
         `public PathResult findPath(GridCell start, GridCell goal, int maxNodes)`
       - Use maxNodes parameter in while loop instead of MAX_NODES constant
       - Keep the constant as DEFAULT_MAX_NODES = 1024 (updated per phase context)

    2. Modify PathfindingService.java:
       - Add private int maxNodes = 1024 field (per phase context decision)
       - Add public void setMaxNodes(int limit) method
       - Add public int getMaxNodes() method
       - Update findPath to pass maxNodes to pathfinder:
         `return pathfinder.findPath(start, goal, maxNodes);`

    Phase context: "Node limit: 1024 nodes (moderate, configurable via PathfindingService)"
  </action>
  <verify>
    Run: `mvn test -q` - all existing tests pass (AStarPathfinderTest, PathfindingServiceTest)
    Verify: Default node limit is 1024, can be changed via setMaxNodes()
  </verify>
  <done>
    PathfindingService exposes setMaxNodes()/getMaxNodes(), AStarPathfinder accepts maxNodes parameter, default is 1024, all tests pass
  </done>
</task>

<task type="auto">
  <name>Task 3: Add getTarget() accessor to Job base class</name>
  <files>
    src/main/java/com/mojang/tower/Job.java
  </files>
  <action>
    1. Add public accessor method to Job base class near existing field declarations:
       ```java
       /**
        * Get the current target entity for this job.
        * Used by Peon for blacklist management when abandoning unreachable targets.
        * @return current target entity, or null if no target
        */
       public Entity getTarget() {
           return target;
       }
       ```

    2. Place method after setTarget() for logical grouping

    Research note: Job.target is protected field. Peon needs access for blacklist operations.
    This follows Java convention of providing accessor for protected field.
  </action>
  <verify>
    Run: `mvn compile -q` - compiles without error
    Verify: Job.getTarget() method exists and returns target field
  </verify>
  <done>
    Job.getTarget() accessor exists, returns target Entity, compiles without error
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. `mvn compile -q` - all code compiles
2. `mvn test -q` - all existing tests pass (no regressions)
3. Verify infrastructure ready for Plan 02:
   - AbandonedTargetSound can be imported and published via EventBus
   - PathfindingService.setMaxNodes(1024) sets node limit
   - Job.getTarget() returns target entity for blacklisting
</verification>

<success_criteria>
- AbandonedTargetSound.java exists and implements SoundEvent (sealed permit added)
- PathfindingService has setMaxNodes()/getMaxNodes() methods with default 1024
- AStarPathfinder.findPath() accepts maxNodes parameter
- Job.getTarget() public accessor exists
- All existing tests pass without modification
- No compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-unreachable-handling/06-01-SUMMARY.md`
</output>
